<% content_for :title, "#{@category.name} — Killeen Furniture" %>
<% content_for :head do %><meta name="turbo-cache-control" content="no-store"><% end %>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
  <div class="mb-6">
    <nav class="text-sm text-gray-400 mb-2">
      <%= link_to "Home", root_path, class: "hover:text-gray-600" %>
      <span class="mx-2">/</span>
      <% if @category.parent %>
        <%= link_to @category.parent.name, category_path(@category.parent), class: "hover:text-gray-600" %>
        <span class="mx-2">/</span>
      <% end %>
      <span class="text-gray-900 font-medium"><%= @category.name %></span>
    </nav>
    <h1 class="text-3xl font-bold text-gray-900"><%= @category.name %></h1>

    <%# Sub-category chips: on a subcategory page show all siblings; on a root page show own children %>
    <% nav_subcats = @category.parent ? @category.parent.subcategories.ordered : @category.subcategories.ordered %>
    <% if nav_subcats.any? %>
      <div class="flex flex-wrap gap-2 mt-3">
        <%# "All [Parent]" pill so user can step back up %>
        <% if @category.parent %>
          <%= link_to "All #{@category.parent.name}", category_path(@category.parent),
              class: "text-sm px-3 py-1 bg-white text-gray-600 rounded-full border border-gray-300 hover:bg-gray-50 transition-colors" %>
        <% end %>
        <% nav_subcats.each do |sub| %>
          <% if sub == @category %>
            <span class="text-sm px-3 py-1 bg-amber-700 text-white rounded-full border border-amber-700 font-medium cursor-default select-none">
              <%= sub.name %>
            </span>
          <% else %>
            <%= link_to sub.name, category_path(sub),
                class: "text-sm px-3 py-1 bg-amber-50 text-amber-800 rounded-full hover:bg-amber-100 border border-amber-200 transition-colors" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# Filter bar %>
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
    <%= form_with url: category_path(@category), method: :get, data: { turbo: false } do |f| %>
      <div class="flex flex-wrap gap-x-4 gap-y-3 items-end">
        <%# In Stock — auto-submits on toggle %>
        <label class="flex items-center gap-2 cursor-pointer h-9">
          <%= f.check_box :in_stock, checked: params[:in_stock] == "1",
              class: "rounded border-gray-300 text-amber-700 focus:ring-amber-500",
              onchange: "this.form.submit()" %>
          <span class="text-sm text-gray-700">In Stock Only</span>
        </label>

        <%# Sort — auto-submits on change %>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Sort by</label>
          <%= f.select :sort,
              options_for_select([["Featured", ""], ["Price: Low to High", "price_asc"], ["Price: High to Low", "price_desc"]], params[:sort]),
              {},
              class: "text-sm border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500",
              onchange: "this.form.submit()" %>
        </div>

        <%# Price Range — submit via button %>
        <div>
          <label class="block text-xs font-medium text-gray-500 mb-1">Price range</label>
          <div class="flex items-center gap-2">
            <%= f.number_field :min_price, value: params[:min_price], placeholder: "Min $", min: 0,
                class: "w-24 text-sm border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" %>
            <span class="text-gray-400 text-sm">–</span>
            <%= f.number_field :max_price, value: params[:max_price], placeholder: "Max $", min: 0,
                class: "w-24 text-sm border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" %>
            <%= f.submit "Apply", class: "text-sm bg-amber-800 text-white px-4 py-2 rounded-md hover:bg-amber-900 cursor-pointer transition-colors" %>
          </div>
        </div>

        <% active_filters = params.permit(:in_stock, :sort, :min_price, :max_price).values.any?(&:present?) %>
        <% if active_filters %>
          <%= link_to "Clear filters", category_path(@category),
              class: "text-sm text-gray-400 hover:text-gray-600 py-2 underline underline-offset-2" %>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @products.empty? %>
    <div class="text-center py-16 bg-white rounded-xl border border-gray-100">
      <h3 class="text-gray-500 font-medium">No products in this category yet</h3>
      <%= link_to "Browse All Products", products_path, class: "mt-4 inline-block text-amber-800 hover:underline" %>
    </div>
  <% else %>
    <p class="text-sm text-gray-500 mb-4"><%= @pagy.count %> products</p>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      <% @products.each do |product| %>
        <%= render "products/product_card", product: product %>
      <% end %>
    </div>
    <% if @pagy.pages > 1 %>
      <div class="mt-8 flex justify-center"><%== @pagy.series_nav %></div>
    <% end %>
  <% end %>
</div>
