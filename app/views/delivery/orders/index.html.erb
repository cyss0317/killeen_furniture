<% content_for :title, "Delivery Queue" %>

<div class="flex items-center justify-between mb-5 flex-wrap gap-3">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Delivery Queue</h1>
    <p class="text-sm text-gray-500 mt-0.5">
      <% if current_user.delivery_admin? %>Your assigned orders<% else %>All orders<% end %>
    </p>
  </div>
</div>

<%# Status filter tabs %>
<div class="flex gap-1 mb-6 border-b border-gray-200 overflow-x-auto">
  <% [
    ["Scheduled",        "scheduled_for_delivery"],
    ["Out for Delivery", "out_for_delivery"],
    ["Delivered",        "delivered"],
    ["Canceled",         "canceled"]
  ].each do |label, value| %>
    <%= link_to label,
        delivery_orders_path(status: value),
        class: "flex-shrink-0 px-4 py-2.5 text-sm font-medium border-b-2 transition-colors whitespace-nowrap #{
          @status_filter == value ? 'border-amber-700 text-amber-800' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
        }" %>
  <% end %>
</div>

<% if @orders.empty? %>
  <div class="text-center py-16 bg-white rounded-lg border border-gray-200">
    <p class="text-gray-400 font-medium">No orders in this category</p>
    <p class="text-sm text-gray-300 mt-1">Check another status tab</p>
  </div>
<% else %>
  <%# Desktop table %>
  <div class="hidden sm:block bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
    <table class="min-w-full divide-y divide-gray-100">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Order</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Address</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Items</th>
          <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
          <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        <% @orders.each do |order| %>
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4">
              <%= link_to order.order_number, delivery_order_path(order),
                  class: "text-sm font-mono font-semibold text-amber-700 hover:text-amber-900 hover:underline" %>
              <p class="text-xs text-gray-400 mt-0.5"><%= order.created_at.strftime("%b %d") %></p>
            </td>
            <td class="px-6 py-4">
              <p class="text-sm text-gray-900 font-medium"><%= order.customer_name %></p>
              <p class="text-xs text-gray-400"><%= order.customer_phone %></p>
            </td>
            <td class="px-6 py-4 hidden md:table-cell">
              <p class="text-sm text-gray-700 leading-snug"><%= order.shipping_address_line %></p>
            </td>
            <td class="px-6 py-4 text-sm text-gray-600">
              <%= order.order_items.sum(:quantity) %> item(s)
            </td>
            <td class="px-6 py-4">
              <span class="px-2 py-1 rounded-full text-xs font-medium <%= status_badge_class(order.status) %>">
                <%= order.status.humanize %>
              </span>
            </td>
            <td class="px-6 py-4 text-right">
              <div class="flex justify-end items-center gap-2">
                <%= link_to "View", delivery_order_path(order),
                    class: "text-sm text-amber-700 hover:text-amber-900 font-medium" %>
                <% if policy(order).mark_delivered? %>
                  <%= button_to "Delivered", mark_delivered_delivery_order_path(order),
                      method: :patch,
                      class: "text-sm bg-green-600 text-white px-3 py-1 rounded-md hover:bg-green-700 transition-colors cursor-pointer",
                      data: { confirm: "Mark order #{order.order_number} as delivered?" } %>
                <% end %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <%# Mobile card layout %>
  <div class="sm:hidden space-y-3">
    <% @orders.each do |order| %>
      <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4">
        <div class="flex items-center justify-between mb-2">
          <%= link_to order.order_number, delivery_order_path(order),
              class: "font-mono font-semibold text-amber-700 text-sm" %>
          <span class="px-2 py-0.5 rounded-full text-xs font-medium <%= status_badge_class(order.status) %>">
            <%= order.status.humanize %>
          </span>
        </div>
        <p class="text-sm font-medium text-gray-900"><%= order.customer_name %></p>
        <p class="text-xs text-gray-400 mb-1"><%= order.customer_phone %></p>
        <p class="text-xs text-gray-500 mb-3"><%= order.shipping_address_line %></p>
        <div class="flex gap-2">
          <%= link_to "View Details", delivery_order_path(order),
              class: "flex-1 text-center text-sm font-medium text-amber-700 border border-amber-300 rounded-md py-2 hover:bg-amber-50 transition-colors" %>
          <% if policy(order).mark_delivered? %>
            <%= button_to "Mark Delivered", mark_delivered_delivery_order_path(order),
                method: :patch,
                class: "flex-1 text-sm font-medium bg-green-600 text-white rounded-md py-2 hover:bg-green-700 transition-colors cursor-pointer",
                data: { confirm: "Mark order #{order.order_number} as delivered?" } %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <% if @pagy.pages > 1 %>
    <div class="mt-6 flex justify-center">
      <%== @pagy.series_nav %>
    </div>
  <% end %>
<% end %>
