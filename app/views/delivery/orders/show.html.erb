<% content_for :title, "Order #{@order.order_number} — Delivery" %>

<div class="flex items-center gap-4 mb-6">
  <%= link_to "← Delivery Queue", delivery_orders_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
  <h1 class="text-2xl font-bold text-gray-900 font-mono"><%= @order.order_number %></h1>
  <span class="px-3 py-1 rounded-full text-sm font-medium <%= status_badge_class(@order.status) %>">
    <%= @order.status.humanize %>
  </span>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 space-y-6">
    <%# Order Items %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="font-semibold text-gray-900">Items to Deliver</h2>
      </div>
      <table class="min-w-full divide-y divide-gray-100">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Qty</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          <% @order_items.each do |item| %>
            <tr>
              <td class="px-6 py-4">
                <p class="text-sm font-medium text-gray-900"><%= item.product_name %></p>
                <p class="text-xs text-gray-400 font-mono">SKU: <%= item.product_sku %></p>
              </td>
              <td class="px-6 py-4 text-center text-sm font-medium"><%= item.quantity %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <%# Delivery Events Timeline %>
    <% if @delivery_events.any? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h2 class="font-semibold text-gray-900 mb-4">Activity Log</h2>
        <ol class="relative border-l border-gray-200 ml-3">
          <% @delivery_events.each do |event| %>
            <li class="mb-5 ml-6">
              <span class="absolute -left-2.5 w-5 h-5 rounded-full flex items-center justify-center
                <%= event.delivered? ? 'bg-green-500' : 'bg-gray-300' %>">
                <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                  <circle cx="10" cy="10" r="5"/>
                </svg>
              </span>
              <div>
                <p class="text-sm font-medium text-gray-900"><%= event.status.humanize %></p>
                <% if event.note.present? %>
                  <p class="text-xs text-gray-500"><%= event.note %></p>
                <% end %>
                <time class="text-xs text-gray-400">
                  <%= event.created_at.strftime("%b %d, %Y %l:%M %p") %>
                </time>
              </div>
            </li>
          <% end %>
        </ol>
      </div>
    <% end %>
  </div>

  <div class="space-y-6">
    <%# Mark Delivered CTA %>
    <% if policy(@order).mark_delivered? %>
      <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
        <div class="text-green-600 text-4xl mb-3">✓</div>
        <h3 class="font-semibold text-gray-900 mb-2">Ready to mark delivered?</h3>
        <p class="text-sm text-gray-500 mb-4">This will record the delivery and close the order.</p>
        <%= button_to "Mark as Delivered", mark_delivered_delivery_order_path(@order),
            method: :patch,
            class: "w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 cursor-pointer text-sm",
            data: { confirm: "Confirm: Mark order #{@order.order_number} as delivered?" } %>
      </div>
    <% elsif @order.delivered? %>
      <div class="bg-green-50 border border-green-200 rounded-lg p-6 text-center">
        <p class="text-green-700 font-semibold">Delivered</p>
        <% if @order.delivered_at %>
          <p class="text-sm text-gray-500 mt-1"><%= @order.delivered_at.strftime("%b %d, %Y %l:%M %p") %></p>
        <% end %>
      </div>
    <% end %>

    <%# Customer info %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-3">Customer</h3>
      <dl class="space-y-2 text-sm">
        <div><dt class="text-gray-500">Name</dt><dd class="font-medium"><%= @order.customer_name %></dd></div>
        <% if @order.customer_phone.present? %>
          <div><dt class="text-gray-500">Phone</dt><dd><%= @order.customer_phone %></dd></div>
        <% end %>
        <div><dt class="text-gray-500">Email</dt><dd class="text-xs"><%= @order.customer_email %></dd></div>
      </dl>
    </div>

    <%# Delivery address %>
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-3">Delivery Address</h3>
      <address class="text-sm text-gray-700 not-italic leading-relaxed">
        <strong><%= @order.shipping_address["full_name"] %></strong><br>
        <%= @order.shipping_address["street_address"] %><br>
        <%= @order.shipping_address["city"] %>, <%= @order.shipping_address["state"] %>
        <%= @order.shipping_address["zip_code"] %>
      </address>
      <% if @order.notes.present? %>
        <div class="mt-3 p-2 bg-yellow-50 border border-yellow-100 rounded text-xs text-gray-600">
          <strong>Notes:</strong> <%= @order.notes %>
        </div>
      <% end %>
    </div>
  </div>
</div>
