<% content_for :title, "Checkout â€” #{APP_NAME}" %>

<div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-10" data-controller="checkout">
  <h1 class="text-2xl font-bold text-gray-900 mb-8">Checkout</h1>

  <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    <!-- Checkout Form -->
    <div class="lg:col-span-3">
      <div id="checkout-errors" class="hidden mb-4 rounded-md bg-red-50 border border-red-200 p-4 text-sm text-red-700"></div>

      <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6">
        <h2 class="font-bold text-gray-900 mb-4">Contact Information</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
            <input type="text" name="checkout[full_name]" required
                   value="<%= @default_address&.full_name || current_user&.full_name %>"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
            <input type="email" name="checkout[email]" required
                   value="<%= current_user&.email %>"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number *</label>
            <input type="tel" name="checkout[phone]" required
                   value="<%= current_user&.phone %>"
                   placeholder="(254) 555-0100"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
          </div>
        </div>
      </div>

      <div class="bg-white rounded-xl border border-gray-100 p-6 mb-6">
        <h2 class="font-bold text-gray-900 mb-4">Delivery Address</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Street Address *</label>
            <input type="text" name="checkout[street_address]" required
                   value="<%= @default_address&.street_address %>"
                   placeholder="123 Main St"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">City *</label>
              <input type="text" name="checkout[city]" required
                     value="<%= @default_address&.city || 'Killeen' %>"
                     class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">State *</label>
              <input type="text" name="checkout[state]" required
                     value="<%= @default_address&.state || 'TX' %>"
                     maxlength="2" placeholder="TX"
                     class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">ZIP Code *</label>
            <input type="text" name="checkout[zip_code]" required
                   value="<%= @default_address&.zip_code %>"
                   placeholder="76541" maxlength="10"
                   data-checkout-target="zipCode"
                   data-action="change->checkout#calculateShipping"
                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-transparent">
            <div id="shipping-result" class="mt-2 text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Payment -->
      <div class="bg-white rounded-xl border border-gray-100 p-6">
        <h2 class="font-bold text-gray-900 mb-4">Payment</h2>
        <div id="card-element" class="border border-gray-300 rounded-md p-3 bg-white">
          <!-- Stripe Card Element will mount here -->
        </div>
        <div id="card-errors" class="mt-2 text-sm text-red-600"></div>

        <div class="mt-4 flex items-center gap-2 text-xs text-gray-400">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Secured by Stripe. Your card info is never stored on our servers.
        </div>
      </div>

      <!-- Submit -->
      <button type="button"
              data-checkout-target="submitButton"
              data-action="click->checkout#handleSubmit"
              class="w-full mt-6 bg-amber-800 text-white font-semibold py-4 px-6 rounded-md hover:bg-amber-900 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-base">
        Place Order
      </button>

      <%# Admin: External Payment Option %>
      <% if user_signed_in? && current_user.admin_or_above? %>
        <details class="mt-4 border border-dashed border-amber-300 rounded-lg">
          <summary class="px-4 py-3 text-sm font-medium text-amber-800 cursor-pointer select-none flex items-center gap-2 hover:bg-amber-50 rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
            </svg>
            Admin: Create Order with External Payment
          </summary>
          <div class="px-4 pb-4 pt-2">
            <p class="text-xs text-gray-500 mb-3">Use this when the customer already paid via Zelle, Venmo, CashApp, or in-person. Stock is decremented immediately.</p>
            <%= form_with url: external_payment_checkout_path, method: :post, id: "external-payment-form", class: "space-y-3" do |f| %>
              <input type="hidden" name="checkout[full_name]"      id="ext_full_name">
              <input type="hidden" name="checkout[email]"          id="ext_email">
              <input type="hidden" name="checkout[phone]"          id="ext_phone">
              <input type="hidden" name="checkout[street_address]" id="ext_street_address">
              <input type="hidden" name="checkout[city]"           id="ext_city">
              <input type="hidden" name="checkout[state]"          id="ext_state">
              <input type="hidden" name="checkout[zip_code]"       id="ext_zip_code">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Reference</label>
                <input type="text" name="external_payment_reference"
                       placeholder="e.g. Zelle - John Smith / CashApp TX-1234"
                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
                <p class="text-xs text-gray-400 mt-1">Include payment method and any transaction reference.</p>
              </div>
              <button type="submit" onclick="copyCheckoutFieldsToExternal(event)"
                      class="w-full bg-gray-800 text-white font-semibold py-3 px-6 rounded-md hover:bg-gray-700 transition-colors text-sm cursor-pointer">
                Create Order (External Payment)
              </button>
            <% end %>
          </div>
        </details>
        <script>
          function copyCheckoutFieldsToExternal(e) {
            const fields = ["full_name", "email", "phone", "street_address", "city", "state", "zip_code"]
            let valid = true
            fields.forEach(field => {
              const src = document.querySelector(`[name="checkout[${field}]"]`)
              const dst = document.getElementById(`ext_${field}`)
              if (src && dst) {
                dst.value = src.value
                if (!src.value.trim()) valid = false
              }
            })
            if (!valid) {
              e.preventDefault()
              alert("Please fill in all contact and address fields before submitting.")
            }
          }
        </script>
      <% end %>

      <% unless user_signed_in? %>
        <p class="text-center text-xs text-gray-400 mt-3">
          Already have an account?
          <%= link_to "Sign in", new_user_session_path, class: "text-amber-800 hover:underline" %>
        </p>
      <% end %>
    </div>

    <!-- Order Summary Sidebar -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl border border-gray-100 p-6 sticky top-20">
        <h2 class="font-bold text-gray-900 mb-4">Order Summary</h2>
        <div class="space-y-3 mb-4">
          <% current_cart.cart_items.includes(:product).each do |item| %>
            <div class="flex gap-3">
              <div class="w-12 h-12 bg-gray-100 rounded-md overflow-hidden flex-shrink-0">
                <% if item.product.primary_image %>
                  <%= image_tag item.product.primary_image.variant(resize_to_fill: [50, 50]),
                      class: "w-full h-full object-cover", alt: item.product.name %>
                <% end %>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900 line-clamp-1"><%= item.product.name %></p>
                <p class="text-xs text-gray-400">Qty: <%= item.quantity %></p>
              </div>
              <p class="text-sm font-semibold"><%= number_to_currency(item.line_total) %></p>
            </div>
          <% end %>
        </div>

        <div class="border-t border-gray-100 pt-4 space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Subtotal</span>
            <span class="font-medium"><%= number_to_currency(current_cart.subtotal) %></span>
          </div>
          <div class="flex justify-between" id="shipping-line">
            <span class="text-gray-600">Shipping</span>
            <span class="text-gray-400" id="shipping-display">Calculated when you enter ZIP</span>
          </div>
          <% if GlobalSetting.tax_rate > 0 %>
            <div class="flex justify-between">
              <span class="text-gray-600">Tax (<%= GlobalSetting.tax_rate %>%)</span>
              <span class="font-medium"><%= number_to_currency(current_cart.subtotal * GlobalSetting.tax_rate / 100) %></span>
            </div>
          <% end %>
        </div>

        <div class="border-t border-gray-100 pt-4 mt-4">
          <div class="flex justify-between font-bold text-base">
            <span>Total</span>
            <span id="order-total"><%= number_to_currency(current_cart.subtotal) %>+</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
