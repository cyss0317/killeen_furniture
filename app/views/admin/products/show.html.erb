<% content_for :title, @product.name %>

<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-4">
    <%= link_to "â† Products", admin_products_path, class: "text-sm text-gray-500 hover:text-gray-700" %>
    <h1 class="text-2xl font-bold text-gray-900"><%= @product.name %></h1>
    <span class="px-2.5 py-0.5 rounded-full text-xs font-medium
      <%= @product.published? ? 'bg-green-100 text-green-700' : @product.draft? ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600' %>">
      <%= @product.status.humanize %>
    </span>
  </div>
  <div class="flex gap-2">
    <%= link_to "Edit", edit_admin_product_path(@product), class: "px-4 py-2 text-sm font-medium border border-gray-300 rounded-md hover:bg-gray-50 transition-colors" %>
    <% if @product.draft? || @product.archived? %>
      <%= button_to "Publish", publish_admin_product_path(@product), method: :patch,
          class: "px-4 py-2 text-sm font-medium bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors cursor-pointer" %>
    <% end %>
  </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 space-y-6">
    <!-- Images -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-3">Images</h3>
      <% if @product.images.attached? %>
        <div class="grid grid-cols-4 gap-2">
          <% @product.images.each do |img| %>
            <div class="aspect-square rounded-md overflow-hidden bg-gray-100">
              <%= image_tag img.variant(resize_to_fill: [120, 120]), class: "w-full h-full object-cover" %>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-sm text-gray-400">No images uploaded. <%= link_to "Edit product", edit_admin_product_path(@product), class: "text-amber-700 hover:underline" %> to add images.</p>
      <% end %>
    </div>

    <!-- Description -->
    <% if @product.description.body.present? %>
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="font-semibold text-gray-900 mb-3">Description</h3>
        <div class="prose text-sm max-w-none"><%= @product.description %></div>
      </div>
    <% end %>

    <!-- Stock Adjustment -->
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-4">Adjust Stock</h3>
      <%= form_with url: update_stock_admin_product_path(@product), method: :patch do |f| %>
        <div class="flex gap-3 items-end">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Quantity Change</label>
            <input type="number" name="quantity_change" placeholder="+10 or -5" required
                   class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 w-36">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
            <select name="reason" required class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500">
              <% StockAdjustment::REASONS.each do |reason| %>
                <option value="<%= reason %>"><%= reason.humanize %></option>
              <% end %>
            </select>
          </div>
          <button type="submit" class="bg-gray-800 text-white text-sm px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
            Update Stock
          </button>
        </div>
      <% end %>

      <!-- Stock History -->
      <% recent_adjustments = @product.stock_adjustments.recent.limit(5) %>
      <% if recent_adjustments.any? %>
        <h4 class="font-medium text-gray-700 mt-6 mb-3 text-sm">Recent Adjustments</h4>
        <table class="min-w-full text-sm">
          <% recent_adjustments.each do |adj| %>
            <tr class="border-b border-gray-50 last:border-0">
              <td class="py-2 pr-4">
                <span class="font-medium <%= adj.quantity_change > 0 ? 'text-green-600' : 'text-red-600' %>">
                  <%= adj.quantity_change > 0 ? '+' : '' %><%= adj.quantity_change %>
                </span>
              </td>
              <td class="py-2 pr-4 text-gray-600"><%= adj.reason.humanize %></td>
              <td class="py-2 text-gray-400 text-xs"><%= adj.created_at.strftime("%b %d, %Y") %></td>
            </tr>
          <% end %>
        </table>
      <% end %>
    </div>
  </div>

  <!-- Sidebar -->
  <div class="space-y-6">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
      <h3 class="font-semibold text-gray-900 mb-4">Product Details</h3>
      <dl class="space-y-3 text-sm">
        <div>
          <dt class="text-gray-500">SKU</dt>
          <dd class="font-mono font-medium"><%= @product.sku %></dd>
        </div>
        <div>
          <dt class="text-gray-500">Category</dt>
          <dd><%= @product.category.name %></dd>
        </div>
        <div>
          <dt class="text-gray-500">Base Cost</dt>
          <dd class="font-medium"><%= number_to_currency(@product.base_cost) %></dd>
        </div>
        <div>
          <dt class="text-gray-500">Markup</dt>
          <dd><%= @product.markup_percentage %>%</dd>
        </div>
        <div>
          <dt class="text-gray-500">Selling Price</dt>
          <dd class="text-lg font-bold text-amber-800"><%= number_to_currency(@product.selling_price) %></dd>
        </div>
        <div>
          <dt class="text-gray-500">Current Stock</dt>
          <dd id="stock-display-<%= @product.id %>"><%= render "admin/products/stock_display", product: @product %></dd>
        </div>
        <% if @product.weight.present? %>
          <div>
            <dt class="text-gray-500">Weight</dt>
            <dd><%= @product.weight %> lbs <%= "(Large item)" if @product.large_item? %></dd>
          </div>
        <% end %>
        <div>
          <dt class="text-gray-500">Featured</dt>
          <dd>
            <%= button_to @product.featured? ? "Remove from featured" : "Add to featured",
                toggle_featured_admin_product_path(@product), method: :patch,
                class: "text-sm text-amber-700 hover:underline bg-transparent border-0 cursor-pointer p-0 font-medium" %>
          </dd>
        </div>
      </dl>
    </div>
  </div>
</div>
